<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NSS NGO | Donation Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .card { background: #1e293b; padding: 20px; border-radius: 10px; border: 1px solid #334155; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #0f172a; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #334155; color: #f8fafc; }
        .status-pending { color: #fbbf24; font-weight: bold; }
        .status-success { color: #10b981; font-weight: bold; }
        .status-failed { color: #ef4444; font-weight: bold; }
        input[type="number"] { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #334155; background: #0f172a; color: white; }
    </style>
</head>
<body class="dark" style="display: block; padding: 20px;">
    <div style="max-width: 900px; margin: auto;">
        
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px;">
            <h1 id="userWelcome">Welcome, User</h1>
            <button onclick="logout()" style="background-color: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                Logout
            </button>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h3>Make a Donation</h3>
                <p style="text-align: left; margin-bottom: 10px;">Support our cause with a secure payment.</p>
                <input type="number" id="donationAmount" placeholder="Enter Amount">
                <button class="primary-btn" onclick="donateNow()" style="width: 100%; cursor: pointer;">Donate Now</button>
            </div>

            <div class="card">
                <h3>My Details</h3>
                <p style="text-align: left;"><strong>Name:</strong> <span id="profName">...</span></p>
                <p style="text-align: left;"><strong>Email:</strong> <span id="profEmail">...</span></p>
            </div>
        </div>

        <div class="card" style="margin-top: 20px;">
            <h3>Donation History</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>

    <script type="text/javascript" src="https://www.payhere.lk/lib/payhere.js"></script>

    <script>
        // 1. Auth Check
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');

        if (!user || !token) {
            window.location.href = "login.html";
        }

        document.getElementById('userWelcome').innerText = `Welcome, ${user.name}`;
        document.getElementById('profName').innerText = user.name;
        document.getElementById('profEmail').innerText = user.email;

        // 2. Load History
        async function loadHistory() {
            try {
                const res = await fetch(`/api/donate/history/${user.id}`, {
                    headers: { 'Authorization': token }
                });
                const data = await res.json();
                const body = document.getElementById('historyBody');
                
                body.innerHTML = data.map(d => `
                    <tr>
                        <td>${new Date(d.date).toLocaleDateString()}</td>
                        <td>$ ${d.amount}</td>
                        <td><span class="status-${d.status}">${d.status.toUpperCase()}</span></td>
                        <td>
                            ${d.status === 'pending' ? 
                            `<button onclick="verifyPayment('${d._id}')" style="cursor:pointer; background:#10b981; border:none; color:white; border-radius:4px; padding:2px 8px;">Verify</button>` 
                            : 'Completed'}
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                console.log("Error loading history", err);
            }
        }

        // 3. MAIN DONATION FUNCTION
        async function donateNow() {
            const amount = document.getElementById('donationAmount').value;
            const orderId = "NSS_" + Math.floor(Math.random() * 1000000);
            const currency = "LKR";

            if (!amount || amount <= 0) {
                alert("Please enter a valid amount");
                return;
            }

            try {
                // A. Record in Database first as Pending
                await fetch('/api/donate/initiate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: user.id, userName: user.name, amount: amount })
                });

                // B. Get Secure Hash from Backend
                const response = await fetch('/api/payment/hash', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_id: orderId, amount: amount, currency: currency })
                });
                const data = await response.json();

                // C. Open PayHere Popup
                const payment = {
                    "sandbox": true,
                    "merchant_id": data.merchantId,
                    
                     return_url: "https://nss-project-gray.vercel.app/success.html",
                     cancel_url: "https://nss-project-gray.vercel.app/donate.html",
                     notify_url: "https://nss-project-gray.vercel.app/api/payment/notify",
                    "order_id": orderId,
                    "items": "NSS NGO Donation",
                    "amount": data.amount,
                    "currency": currency,
                    "hash": data.hash,
                    "first_name": user.name,
                    "last_name": "Donor",
                    "email": user.email,
                    "phone": "0771234567",
                    "address": "No 1, Main St",
                    "city": "Colombo",
                    "country": "Sri Lanka"
                };

                payhere.startPayment(payment);

            } catch (error) {
                console.error("Payment Error:", error);
                alert("Failed to initiate payment. Check server connection.");
            }
        }

        // 4. PayHere Events
        payhere.onCompleted = function onCompleted(orderId) {
            alert("Donation Successful! Order ID: " + orderId);
            loadHistory(); // Refresh the table
            window.location.href = "/success.html";
        };

        payhere.onDismissed = function onDismissed() {
            console.log("Payment window closed");
        };

        payhere.onError = function onError(error) {
            alert("Payment Error: " + error);
        };

        // 5. Verify & Logout
        async function verifyPayment(id) {
            const res = await fetch(`/api/donate/verify/${id}`, { method: 'PUT' });
            if (res.ok) {
                alert("Payment Verified!");
                loadHistory(); 
            }
        }

        function logout() {
            localStorage.clear();
            alert("Logged out successfully");
            window.location.href = "login.html";
        }

        loadHistory();
    </script>
</body>
</html>