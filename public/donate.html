<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>NSS NGO | Donation Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .card {
            background: #1e293b;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #334155;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: #0f172a;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #334155;
            color: #f8fafc;
        }

        .status-pending {
            color: #fbbf24;
            font-weight: bold;
        }

        .status-success {
            color: #10b981;
            font-weight: bold;
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #334155;
            background: #0f172a;
            color: white;
        }

        /* Stripe Element Styling */
        #card-element {
            background: #0f172a;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #334155;
            margin-bottom: 20px;
        }

        .StripeElement {
            width: 100%;
            color: white;
        }

        .StripeElement--invalid {
            border-color: #ef4444;
        }
    </style>
</head>

<body class="dark" style="padding:20px;">
    <div style="max-width:900px;margin:auto;">

        <div style="display:flex;justify-content:space-between;align-items:center;">
            <h1 id="userWelcome">Welcome</h1>
            <button onclick="logout()"
                style="background:#ef4444;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;">Logout</button>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <h3>Make a Donation</h3>
                <p>Support our cause with a secure payment.</p>

                <label>Amount (LKR)</label>
                <input type="number" id="donationAmount" placeholder="Enter Amount">

                <label>Card Details</label>
                <div id="card-element">
                    <!-- Stripe Card Element -->
                </div>

                <button id="submitBtn" class="primary-btn" style="width:100%;" onclick="processDonation()">Donate
                    Now</button>
            </div>
            <div class="card">
                <h3>My Details</h3>
                <p><strong>Name:</strong> <span id="profName"></span></p>
                <p><strong>Email:</strong> <span id="profEmail"></span></p>
            </div>
        </div>

        <div class="card" style="margin-top:20px;">
            <h3>Donation History</h3>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount (LKR)</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="historyBodyTable"></tbody>
            </table>
        </div>

    </div>

    <script>
        /* ---------------- AUTH ---------------- */
        const user = JSON.parse(localStorage.getItem("user"));
        const token = localStorage.getItem("token");

        if (!user || !token) {
            window.location.href = "login.html";
        }

        document.getElementById("userWelcome").innerText = `Welcome, ${user.name}`;
        document.getElementById("profName").innerText = user.name;
        document.getElementById("profEmail").innerText = user.email;

        let stripe;
        let card;

        /* ---------------- INITIALIZE STRIPE ---------------- */
        async function setupStripe() {
            try {
                const { publishableKey } = await fetch("/api/payment/config").then(r => r.json());
                stripe = Stripe(publishableKey);

                const elements = stripe.elements({
                    fonts: [{ cssSrc: 'https://fonts.googleapis.com/css?family=Roboto' }]
                });

                const style = {
                    base: {
                        color: "#ffffff",
                        fontFamily: 'Roboto, sans-serif',
                        fontSmoothing: "antialiased",
                        fontSize: "16px",
                        "::placeholder": {
                            color: "#aab7c4"
                        }
                    },
                    invalid: {
                        color: "#fa755a",
                        iconColor: "#fa755a"
                    }
                };

                card = elements.create("card", { style: style });
                card.mount("#card-element");
            } catch (e) {
                console.error("Stripe Setup Error:", e);
            }
        }
        setupStripe();

        /* ---------------- LOAD HISTORY ---------------- */
        async function loadHistory() {
            try {
                const res = await fetch(`/api/donate/history/${user.id}`, {
                    headers: { Authorization: token }
                });
                const data = await res.json();
                const tbody = document.getElementById("historyBodyTable");

                tbody.innerHTML = data.map(d => `
            <tr>
                <td>${new Date(d.date).toLocaleDateString()}</td>
                <td>${Number(d.amount).toFixed(2)}</td>
                <td class="status-${d.status}">${d.status.toUpperCase()}</td>
                <td>${d.status === "pending" ? `<button onclick="verifyPayment('${d._id}')">Verify</button>` : "Completed"}</td>
            </tr>
        `).join("");
            } catch (e) {
                console.error("History Error:", e);
            }
        }

        /* ---------------- PROCESS DONATION ---------------- */
        async function processDonation() {
            const amountInput = document.getElementById("donationAmount").value;
            if (!amountInput || amountInput <= 0) {
                alert("Enter a valid amount");
                return;
            }

            const amount = Number(amountInput).toFixed(2);
            const orderId = "NSS_" + Date.now();

            const submitBtn = document.getElementById("submitBtn");
            submitBtn.disabled = true;
            submitBtn.innerText = "Processing...";

            try {
                // 1. Initiate Donation (Pending)
                const initRes = await fetch("/api/donate/initiate", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": token
                    },
                    body: JSON.stringify({
                        userId: user.id || user._id,
                        userName: user.name,
                        amount: amount,
                        transactionId: orderId
                    })
                });

                if (!initRes.ok) throw new Error("Failed to initiate donation");
                const donationRecord = await initRes.json();

                // 2. Create Payment Intent
                const intentRes = await fetch("/api/payment/create-payment-intent", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ amount, currency: "lkr" }),
                });

                const { clientSecret } = await intentRes.json();
                if (!clientSecret) throw new Error("Failed to initialize payment");

                // 3. Confirm Payment
                const result = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: card,
                        billing_details: {
                            name: user.name,
                            email: user.email
                        }
                    }
                });

                if (result.error) {
                    // Show error to your customer
                    alert(result.error.message);
                    submitBtn.disabled = false;
                    submitBtn.innerText = "Donate Now";
                } else {
                    // Payment Success
                    if (result.paymentIntent.status === 'succeeded') {
                        alert("Payment Successful! Thank you.");

                        // 4. Verify/Update Status in Backend
                        await verifyPayment(donationRecord._id);

                        // Clear inputs
                        document.getElementById("donationAmount").value = "";
                        card.clear();

                        submitBtn.disabled = false;
                        submitBtn.innerText = "Donate Now";
                    }
                }

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                submitBtn.disabled = false;
                submitBtn.innerText = "Donate Now";
            }
        }

        /* ---------------- VERIFY & LOGOUT ---------------- */
        async function verifyPayment(id) {
            await fetch(`/api/donate/verify/${id}`, { method: "PUT" });
            loadHistory();
        }

        function logout() {
            localStorage.clear();
            window.location.href = "login.html";
        }

        loadHistory();
    </script>
</body>

</html>